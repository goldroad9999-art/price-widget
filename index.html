<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>오늘의 시세 (VAT 별도)</title>

<style>
body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Apple SD Gothic Neo,Noto Sans KR,sans-serif;
  background:#0f1115;
  color:#f5f5f5;
}

.wrap{
  max-width:720px;
  margin:auto;
  padding:20px;
}

h1{
  font-size:18px;
  font-weight:550;
  margin-bottom:8px;
}

.meta{
  font-size:12px;
  color:#a1a1aa;
  margin-bottom:22px;
  line-height:1.6;
}

.cards{
  display:grid;
  grid-template-columns:1fr;
  gap:20px;
}

.card{
  background:#171a21;
  border:1px solid #262b36;
  border-radius:18px;
  padding:24px;
}

.title{
  font-size:17px;
  font-weight:600;
}

.sub{
  font-size:12px;
  color:#9ca3af;
  margin-top:4px;
}

.price{
  font-size:24px;
  font-weight:600;
  margin-top:18px;
}

.perg{
  margin-top:10px;
  font-size:14px;
  color:#d1d5db;
}

.perg span{ color:#9ca3af; }

.delta{
  margin-top:12px;
  font-weight:600;
  font-size:14px;
}

.up{color:#ff5252;}
.down{color:#4dabf7;}

.note{
  margin-top:28px;
  font-size:12px;
  color:#9ca3af;
}

.loading{
  text-align:center;
  padding:40px;
  color:#9ca3af;
}
</style>
</head>

<body>
<div class="wrap">

<h1>오늘의 시세 (VAT 별도)</h1>

<div class="meta">
  <div id="date">기준일: -</div>
  <div id="fx">USD/KRW: -</div>
  <div id="update">업데이트: -</div>
</div>

<div id="loading" class="loading">시세 불러오는 중...</div>
<div class="cards" id="cards"></div>

<div class="note">
※ 국제 시세(USD/oz) + 환율 기반 자동 산출<br>
※ 실제 판매가는 업체 정책에 따라 달라질 수 있습니다.
</div>

</div>

<script>
const OZ_TO_G = 31.1034768;
const DON = 3.75;

// 삼성 보정
const ADJUST_GOLD = 1.05095;
const ADJUST_SILVER = 1.40270;
const ADJUST_PLAT = 1.07371;

const fmt = n => new Intl.NumberFormat("ko-KR").format(Math.round(n)) + "원";
const fmtFx = n => new Intl.NumberFormat("ko-KR",{maximumFractionDigits:2}).format(n);

/* ---------------- 환율 캐시 (속도 핵심) ---------------- */
let FX_CACHE={value:null,ts:0};
async function fetchFx(){
  const now=Date.now();
  if(FX_CACHE.value && now-FX_CACHE.ts<10*60*1000){
    return FX_CACHE.value;
  }
  const r=await fetch("https://open.er-api.com/v6/latest/USD");
  const j=await r.json();
  FX_CACHE={value:j.rates.KRW,ts:now};
  return FX_CACHE.value;
}

/* ---------------- 금속 데이터 ---------------- */
async function fetchMetal(symbol){
  const r=await fetch(`/.netlify/functions/metal?symbol=${symbol}`);
  return r.json();
}

/* ---------------- 카드 HTML ---------------- */
function cardHtml(title,perDonPrice,changePct){
  const perG=perDonPrice/DON;
  const up=changePct>=0;
  const arrow=up?"▲":"▼";
  const cls=up?"up":"down";

  return `
  <div class="card">
    <div class="title">${title}</div>
    <div class="sub">1돈(3.75g) 기준</div>

    <div class="price">${fmt(perDonPrice)}</div>

    <div class="perg"><span>1g 기준가:</span> ${fmt(perG)}</div>

    <div class="delta ${cls}">
      ${arrow} ${Math.abs(changePct).toFixed(2)}%
    </div>
  </div>`;
}

/* ---------------- 렌더 ---------------- */
async function render(){
  try{

    // ⭐ 동시 요청 (속도 핵심)
    const [fx,gold,silver,plat]=await Promise.all([
      fetchFx(),
      fetchMetal("xauusd"),
      fetchMetal("xagusd"),
      fetchMetal("xptusd")
    ]);

    document.getElementById("loading").style.display="none";

    document.getElementById("date").textContent="기준일: "+gold.date;
    document.getElementById("fx").textContent="USD/KRW: "+fmtFx(fx);
    document.getElementById("update").textContent="업데이트: "+new Date().toLocaleString("ko-KR");

    const goldPerDon=(gold.close*fx)/OZ_TO_G*DON*ADJUST_GOLD;
    const silverPerDon=(silver.close*fx)/OZ_TO_G*DON*ADJUST_SILVER;
    const platPerDon=(plat.close*fx)/OZ_TO_G*DON*ADJUST_PLAT;

    document.getElementById("cards").innerHTML=
      cardHtml("순금 시세",goldPerDon,gold.change_pct)+
      cardHtml("백금 시세",platPerDon,plat.change_pct)+
      cardHtml("은 시세",silverPerDon,silver.change_pct);

  }catch(e){
    document.getElementById("loading").textContent="시세 불러오기 실패";
    console.error(e);
  }
}

render();
setInterval(render,600000);
</script>

</body>
</html>
// ✅ 로드시만
render();

// ✅ 수동 새로고침 버튼
document.getElementById("refreshBtn").addEventListener("click", () => render());
</script>
</body>
</html>
