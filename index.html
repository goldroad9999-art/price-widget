<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>오늘의 시세 (도매가, 100% 기준가)</title>

<style>
:root{
  --border:#e9e9e9;
  --muted:#6b7280;
  --bg:#ffffff;
  --card:#ffffff;
  --pill:#f3f4f6;
  --up:#dc2626;     /* 빨강 */
  --down:#2563eb;   /* 파랑 */
  --shadow: 0 8px 24px rgba(0,0,0,0.06);
}

body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Apple SD Gothic Neo,Noto Sans KR,sans-serif;
  background:var(--bg);
  color:#111827;
}

.wrap{max-width:980px;margin:auto;padding:20px;}

.header{
  display:flex; align-items:flex-end; justify-content:space-between; gap:12px; flex-wrap:wrap;
  margin-bottom:10px;
}

h1{
  font-size:24px;
  margin:0;
  letter-spacing:-0.2px;
}
.subtitle{
  margin-top:6px;
  font-size:13px;
  color:var(--muted);
}

.meta{
  display:flex; gap:8px; flex-wrap:wrap; align-items:center;
}
.pill{
  background:var(--pill);
  border-radius:999px;
  padding:6px 10px;
  font-size:12px;
  color:#374151;
  white-space:nowrap;
}

.actions{
  display:flex; gap:8px; flex-wrap:wrap;
  margin:14px 0 16px;
}
.btn{
  display:inline-flex; align-items:center; justify-content:center;
  padding:10px 12px;
  border-radius:12px;
  border:1px solid var(--border);
  background:#fff;
  font-weight:800;
  font-size:13px;
  text-decoration:none;
  color:#111827;
}
.btn.primary{
  background:#111827; color:#fff; border-color:#111827;
}
.btn:active{ transform: translateY(1px); }

.table{
  border:1px solid var(--border);
  border-radius:16px;
  overflow:hidden;
  background:var(--card);
  box-shadow: var(--shadow);
}

.row{
  display:grid;
  grid-template-columns: 1.2fr 0.9fr 0.9fr;
  gap:14px;
  padding:16px;
  border-bottom:1px solid var(--border);
  align-items:center;
}

.row:last-child{border-bottom:none;}

.head{
  background:#fafafa;
  font-weight:900;
  color:#111827;
}
.name{
  font-weight:900;
  font-size:18px;
}
.sub{
  color:var(--muted);
  font-size:12.5px;
  margin-top:5px;
  line-height:1.35;
}
.price{
  text-align:right;
  font-size:22px;
  font-weight:950;
  letter-spacing:-0.3px;
}
.small{
  margin-top:4px;
  font-size:12px;
  color:var(--muted);
  text-align:right;
}
.delta{
  display:inline-flex;
  align-items:center;
  gap:6px;
  font-size:12px;
  font-weight:900;
  margin-top:6px;
}
.delta.up{ color: var(--up); }
.delta.down{ color: var(--down); }
.delta .badge{
  border:1px solid currentColor;
  border-radius:999px;
  padding:2px 8px;
  font-size:11px;
  font-weight:900;
}

.note{
  margin-top:14px;
  font-size:13px;
  color:#4b5563;
  line-height:1.6;
}
.err{
  margin-top:12px;
  font-size:13px;
  color:#b91c1c;
  font-weight:900;
  display:none;
}

@media (max-width:820px){
  .row{ grid-template-columns: 1fr; }
  .head{ display:none; }
  .price{ text-align:left; display:flex; justify-content:space-between; align-items:baseline; }
  .price::before{ content:attr(data-label); font-size:13px; color:var(--muted); font-weight:900; }
  .small{ text-align:left; margin-left:0; }
}
</style>
</head>

<body>
<div class="wrap">

  <div class="header">
    <div>
      <h1>오늘의 시세 (도매가, 100% 기준가)</h1>
      <div class="subtitle">국제 시세(USD/oz) + 환율 기반 자동 산출 · 고객 참고용 표시</div>
    </div>
    <div class="meta">
      <div class="pill" id="updatedAt">업데이트: -</div>
      <div class="pill" id="usdkrw">USD/KRW: -</div>
      <div class="pill" id="basedOn">기준일: -</div>
    </div>
  </div>

  <div class="actions">
    <!-- ✅ 여기에 네 상품/카테고리 링크 넣으면 판매용으로 딱 좋아 -->
    <a class="btn primary" id="btnShop" href="#" target="_blank" rel="noopener">금/은 상품 보러가기</a>
    <a class="btn" id="btnKakao" href="#" target="_blank" rel="noopener">카톡 상담하기</a>
    <a class="btn" href="#notice">안내/유의사항</a>
  </div>

  <div class="table">
    <div class="row head">
      <div></div>
      <div style="text-align:right;">내가 살 때 (VAT 포함)</div>
      <div style="text-align:right;">내가 팔 때</div>
    </div>
    <div id="rows"></div>
  </div>

  <div class="note" id="notice">
    ※ 본 시세는 국제 시세(USD/oz) 및 환율을 기반으로 산출한 <b>도매가(100% 기준가)</b>입니다. 실제 판매가는 상품/수량/가공비/프리미엄에 따라 달라질 수 있습니다.<br/>
    ※ 무료 데이터 특성상 “실시간 틱”이 아닌 <b>종가/지연</b>일 수 있습니다.<br/>
    ※ 표시 단위: 1돈(3.75g). 18K/14K는 순금 대비 함량 기준으로 환산합니다.
  </div>

  <div class="err" id="err"></div>

</div>

<script>
/** ====== 판매 정책(여기 숫자만 바꾸면 됨) ====== */
const VAT_RATE = 0.10;
const BUY_PREMIUM = 0.015;
const SELL_DISCOUNT = 0.015;

/** ====== 링크(판매용) ====== */
const PRODUCT_URL = "#"; // 예: https://yourshop.com/category/gold
const KAKAO_URL = "#";   // 예: 카카오 채널 링크

document.getElementById("btnShop").href = PRODUCT_URL;
document.getElementById("btnKakao").href = KAKAO_URL;

/** ====== 단위 ====== */
const OZ_TO_G = 31.1034768;
const DON = 3.75;

const fmtKRW = n => new Intl.NumberFormat("ko-KR").format(Math.round(n)) + "원";
const fmtFx = n => new Intl.NumberFormat("ko-KR", { maximumFractionDigits: 2 }).format(n);
const fmtUSD = n => new Intl.NumberFormat("en-US", { maximumFractionDigits: 2 }).format(n);

const rowsEl = document.getElementById("rows");
const updatedAtEl = document.getElementById("updatedAt");
const usdkrwEl = document.getElementById("usdkrw");
const basedOnEl = document.getElementById("basedOn");
const errEl = document.getElementById("err");

async function fetchUsdKrw(){
  const r = await fetch("https://open.er-api.com/v6/latest/USD", { cache:"no-store" });
  const j = await r.json();
  if (j?.result !== "success" || !j?.rates?.KRW) throw new Error("환율을 불러오지 못했어요.");
  return j.rates.KRW;
}

// Netlify Function (CORS 해결)
async function fetchMetal(symbol){
  const r = await fetch(`/.netlify/functions/metal?symbol=${encodeURIComponent(symbol)}`, { cache:"no-store" });
  if (!r.ok) throw new Error(`시세 함수 오류(${symbol})`);
  return r.json(); // {date, close, prev_date, prev_close, change, change_pct}
}

function deltaHtml(changePct){
  const up = changePct >= 0;
  const cls = up ? "up" : "down";
  const arrow = up ? "▲" : "▼";
  const absPct = Math.abs(changePct);
  return `<div class="delta ${cls}"><span class="badge">${arrow} ${absPct.toFixed(2)}%</span><span>전일 대비</span></div>`;
}

function buildRow(title, perDonKRW, subText, changePct){
  const buy = perDonKRW * (1 + BUY_PREMIUM) * (1 + VAT_RATE);
  const sell = perDonKRW * (1 - SELL_DISCOUNT);

  return `
    <div class="row">
      <div>
        <div class="name">${title}</div>
        <div class="sub">${subText}</div>
        ${Number.isFinite(changePct) ? deltaHtml(changePct) : ""}
      </div>

      <div>
        <div class="price" data-label="살 때">${fmtKRW(buy)}</div>
        <div class="small">1g ≈ ${fmtKRW((perDonKRW/DON) * (1+BUY_PREMIUM) * (1+VAT_RATE))}</div>
      </div>

      <div>
        <div class="price" data-label="팔 때">${fmtKRW(sell)}</div>
        <div class="small">1g ≈ ${fmtKRW((perDonKRW/DON) * (1-SELL_DISCOUNT))}</div>
      </div>
    </div>
  `;
}

async function render(){
  try{
    errEl.style.display = "none";
    errEl.textContent = "";

    const [usdkrw, gold, silver, platinum] = await Promise.all([
      fetchUsdKrw(),
      fetchMetal("xauusd"),
      fetchMetal("xagusd"),
      fetchMetal("xptusd"),
    ]);

    usdkrwEl.textContent = `USD/KRW: ${fmtFx(usdkrw)}`;

    // 기준일 표시(세 금속 중 최신 날짜를 대표로)
    const baseDate = [gold?.date, silver?.date, platinum?.date].filter(Boolean).sort().pop() || "-";
    basedOnEl.textContent = `기준일: ${baseDate}`;

    // USD/oz → KRW/돈
    const goldPerDon = (gold.close * usdkrw) / OZ_TO_G * DON;
    const silverPerDon = (silver.close * usdkrw) / OZ_TO_G * DON;
    const platPerDon = (platinum.close * usdkrw) / OZ_TO_G * DON;

    rowsEl.innerHTML =
      buildRow(
        "순금시세",
        goldPerDon,
        `Gold 24K · 1돈(3.75g) · 국제 ${fmtUSD(gold.close)} USD/oz`,
        gold.change_pct
      ) +
      buildRow(
        "18K 금시세",
        goldPerDon * (18/24),
        `Gold 18K(함량 환산) · 1돈(3.75g)`,
        gold.change_pct
      ) +
      buildRow(
        "14K 금시세",
        goldPerDon * (14/24),
        `Gold 14K(함량 환산) · 1돈(3.75g)`,
        gold.change_pct
      ) +
      buildRow(
        "백금시세",
        platPerDon,
        `Platinum · 1돈(3.75g) · 국제 ${fmtUSD(platinum.close)} USD/oz`,
        platinum.change_pct
      ) +
      buildRow(
        "은시세",
        silverPerDon,
        `Silver · 1돈(3.75g) · 국제 ${fmtUSD(silver.close)} USD/oz`,
        silver.change_pct
      );

    updatedAtEl.textContent = `업데이트: ${new Date().toLocaleString("ko-KR")}`;

  } catch(e){
    errEl.style.display = "block";
    errEl.textContent = "시세를 불러오지 못했어요: " + (e?.message || e);
  }
}

render();
// 10분마다 갱신(무료 소스 보호 + 판매용 ‘오늘 기준가’엔 충분)
setInterval(render, 10 * 60 * 1000);
</script>
</body>
</html>
